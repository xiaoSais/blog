(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{245:function(s,n,a){"use strict";a.r(n);var e=a(17),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"深入理解-jsonp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#深入理解-jsonp"}},[s._v("#")]),s._v(" 深入理解 Jsonp")]),s._v(" "),a("p",[s._v("Jsonp 是一种跨域的手段。")]),s._v(" "),a("p",[s._v("因为浏览器的同源策略，不同源脚本不能共享cookie、不能互相操作 dom ，也不能发起 ajax 请求。")]),s._v(" "),a("h2",{attrs:{id:"同源策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#同源策略"}},[s._v("#")]),s._v(" 同源策略")]),s._v(" "),a("p",[s._v("1、页面所在的服务1(端口3001):")]),s._v(" "),a("p",[s._v("Server:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  const express = require('express')\n  const app = express()\n  const port = 3001\n  app.use(express.static('public'))\n\n  app.get('/data', (req, res) => res.send('Hello World!'))\n\n  app.listen(port, () => console.log(`Example app listening on port ${port}!`))\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("Page:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  <html>\n    <body>\n      <div>page</div>\n    </body>\n  </html>\n  <script src=\"https://unpkg.com/axios/dist/axios.min.js\"></>\n\n  <script>\n    axios.get('http://localhost:3000/data', {\n      firstName: 'lucy',\n      lastName: 'hii'\n    }).then(res => {\n      console.log(res.data)\n    })\n  <\/script>\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("2、接口所在的服务2（端口3000）")]),s._v(" "),a("p",[s._v("Server:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  const express = require('express')\n  const app = express()\n  const port = 3000\n\n  app.get('/data', (req, res) => res.send('Hello World!'))\n\n  app.listen(port, () => console.log(`Example app listening on port ${port}!`))\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("3001 端口的页面试图访问 3000 端口的接口浏览器报错。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("(index):1 Access to XMLHttpRequest at 'http://localhost:3000/data' from origin 'http://localhost:3001' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"jsonp-跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jsonp-跨域"}},[s._v("#")]),s._v(" Jsonp 跨域")]),s._v(" "),a("p",[s._v("Jsonp 利用了通过 scrip 标签请求 Js 文件没有同源策略限制的特性。")]),s._v(" "),a("p",[s._v("我们项目中为了增加 Js 的加载速度用了各种 CDN，这些 CDN的域和项目本身所在的域大多不同，也是利用了这一特性。")]),s._v(" "),a("p",[s._v("打开 www.baidu.com 首页的开发者模式：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<script src="https://dss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/js/min_super-224c7a98dc.js"><\/script>\n\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("b",[s._v("百度首页也干了！")])]),s._v(" "),a("h3",{attrs:{id:"如何实现-jsonp-跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何实现-jsonp-跨域"}},[s._v("#")]),s._v(" 如何实现 Jsonp 跨域")]),s._v(" "),a("p",[s._v("你想啊，我们发起 Jsonp 请求，比如我想发请求 1，是不是要在代码里写：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('  <script src="https://otherDomain/1"><\/script>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("那我想发请求 2呢，是不是要在代码里写好：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('  <script src="https://otherDomain/2"><\/script>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("好，那现在有个场景是在文章列表根据文章 id 去拿文章详情，这个id是动态的要怎么办呢？")]),s._v(" "),a("p",[s._v("很明显不能在代码里写死了，但我们可以动态创建 script 标签啊：")]),s._v(" "),a("p",[s._v("Client.js")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  function sendJsonpRequest(callbackName, url, params) {\n    let jsonpDom = document.querySelector('#jsonp')\n    if (jsonpDom) document.querySelector('body').removeChild(jsonpDom)\n    const s = document.createElement('script')\n    const param = qs.stringify(Object.assign({ callback: callbackName }, params))\n    s.src = `${url}?${param}`\n    s.id = 'jsonp'\n    document.querySelector('body').appendChild(s)\n  }\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("我们的 sendJsonpRequest() 方法可以动态的传 params 并创建 script 标签，src 属性指向我们拼接的url。qs.stringify 方法主要是将 js 对象转化成 key = value 的字符串形式。为了避免发起很多请求时创建过多无效的标签，我们发请求时先把以前创建的节点清除掉。")]),s._v(" "),a("p",[s._v("那我们假设成功发起请求了，我们要怎么拿到后端传的数据呢。")]),s._v(" "),a("p",[s._v("我们想到在请求Js的时候，"),a("b",[s._v("Js会立刻下载并执行")]),s._v("。 那么后端只需返回携带数据的Js代码就可以了，前端会立刻执行这段代码。")]),s._v(" "),a("p",[s._v("所以后端完全可以返回一个方法的调用，这个方法传参就是返回的数据，同时在客户端有该回调函数的定义。")]),s._v(" "),a("p",[s._v("Client.js")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  // 拿到数据的回调\n  function getArticleData (data) {\n    console.log(data.id)\n    // 执行其他业务逻辑\n  }\n\n  // 发起请求\n  sendJsonpRequest('getArticleData', 'http://localhost:3000/login', {id: 2})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("同时后端可以通过 sendJsonpRequest 方法知道需要返回的函数名。")]),s._v(" "),a("p",[s._v("Server")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const express = require('express')\nconst app = express()\nconst port = 3000\n\napp.get('/login', (req, res) => { \n  res.set('Content-Type', 'text/javascript')\n  console.log(req.query)\n  // 根据不同的 id 返回不同的数据\n  let data\n  switch ( req.query.id ) {\n    case '2':\n      data = {name: 'lucy', age: 23, id: 2}\n      break;\n    case  '1':\n      data = {name: 'peter', age: 34, id: 1}\n      break\n  }\n  res.send(`${req.query.callback}(${JSON.stringify(data)})`) \n})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("比如上面那个例子，后端返回的是：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('  getArticleData({"name":"peter","age":34,"id":2})\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("后端拿到 id 或者 callback 函数名可以执行不同的操作逻辑，最后组合成函数调用返回给前端。前端执行这段逻辑就能拿到数据啦。")]),s._v(" "),a("p",[s._v("没错，JsonP 就是这么简单！")]),s._v(" "),a("h3",{attrs:{id:"附录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#附录"}},[s._v("#")]),s._v(" 附录")]),s._v(" "),a("p",[s._v("完整的代码示例")]),s._v(" "),a("p",[s._v("Client.js")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  <html>\n  <body>\n    <div>page</div>\n  </body>\n\n</html>\n<script src=\"https://unpkg.com/axios/dist/axios.min.js\"><\/script>\n\n<script>\n  \n  function getArticleData(data) {\n    console.log(data.name)\n  }\n  const qs = {\n    stringify: function (obj) {\n      if (typeof obj !== 'object') throw new Error('not obj')\n      else return Object.keys(obj).map(key => `${key}=${obj[key]}`).join('&')\n    }\n  }\n  function sendJsonpRequest(callbackName, url, params) {\n    let jsonpDom = document.querySelector('#jsonp')\n    if (jsonpDom) document.querySelector('body').removeChild(jsonpDom)\n    const s = document.createElement('script')\n    const param = qs.stringify(Object.assign({ callback: callbackName }, params))\n    s.src = `${url}?${param}`\n    s.id = 'jsonp'\n    document.querySelector('body').appendChild(s)\n  }\n  sendJsonpRequest('getArticleData', 'http://localhost:3000/login', {id: 2})\n<\/script>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("p",[s._v("Server.js")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("\nconst express = require('express')\nconst app = express()\nconst port = 3000\n\napp.get('/login', (req, res) => { \n  res.set('Content-Type', 'text/javascript')\n  console.log(req.query)\n  // 根据不用的callback 传递不同的数据\n  let data\n  switch ( req.query.id ) {\n    case '1':\n      data = {name: 'lucy', age: 23, id: 1}\n      break;\n    case  '2':\n      data = {name: 'peter', age: 34, id: 2}\n      break\n  }\n  res.send(`${req.query.callback}(${JSON.stringify(data)})`) \n})\n\napp.listen(port, () => console.log(`Example app listening on port ${port}!`))\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h3",{attrs:{id:"总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),a("p",[s._v("1、JSONP的优点是：它不像XMLHttpRequest对象实现的Ajax请求那样受到同源策略的限制；它的兼容性更好，在更加古老的浏览器中都 可以运行，不需要XMLHttpRequest或ActiveX的支持；并且在请求完毕后可以通过调用callback的方式回传结果。")]),s._v(" "),a("p",[s._v("2、JSONP的缺点则是：它只支持GET请求而不支持POST等其它类型的HTTP请求；它只支持跨域HTTP请求这种情况，不能解决不同域的两个页面之间如何进行JavaScript调用的问题。")]),s._v(" "),a("p",[s._v("3、JSONP的最基本的原理是：动态添加一个标签，而script标签的src属性是没有跨域的限制的。这样说来，这种跨域方式其实与ajax XmlHttpRequest协议无关了。\njsonp的本质是：动态创建script标签，然后通过他的src属性发送跨域请求，不同意然后服务器相应的数据格式为【函数调用foo（实参）】，所以在发送请求之前必须声明一个函数，并且函数的名字与参数中传递的名字要一致。")]),s._v(" "),a("p",[s._v("可以说jsonp的方式原理上和是一致的，因为他的原理实际上就是 使用js的script标签 进行传参，那么必然是get方式的了，和浏览器中敲入一个url一样")]),s._v(" "),a("p",[s._v("原理就是从服务端加载一段脚本（用script标签），然后把数据放到一个函数参数里面，再然后浏览器里定义的那个函数就能拿到那个数据了~所以为啥不能发post 因为标签里只能发get，虽然， jsonp 的实现跟 ajax 没有半毛钱关系，jsonp是通过 script的src实现的，但是最终目的都是向服务器请求数据然后回调，而且为了方便，所以jquery把 jsonp 也封装在了 $.ajax 方法中，调用方式与 ajax 调用方式略有区别。")])])}),[],!1,null,null,null);n.default=t.exports}}]);